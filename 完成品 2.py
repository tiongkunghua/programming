import sys
import subprocess
import time
import random
import os
import uuid
from pathlib import Path
import tempfile
import re
import numpy as np

# ==========================================
# è‡ªå‹•å®‰è£å¥—ä»¶åŠŸèƒ½
# ==========================================
def install_package(package):
    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", package])
    except:
        pass

needed_packages = {
    "sounddevice": "sounddevice",
    "scipy": "scipy",
    "numpy": "numpy",
    "speech_recognition": "SpeechRecognition",
    "edge_tts": "edge-tts",
    "nest_asyncio": "nest_asyncio",
    "pygame": "pygame",
    "pypinyin": "pypinyin"
}

for module, package in needed_packages.items():
    try:
        __import__(module)
    except ImportError:
        print(f"ğŸ“¦ æ­£åœ¨å®‰è£å¿…è¦å…ƒä»¶: {package}...")
        install_package(package)

import sounddevice as sd
import scipy.io.wavfile as wav
import speech_recognition as sr
import edge_tts
import asyncio
import nest_asyncio
import pygame
from pypinyin import pinyin, Style

# ==========================================
# æ ¸å¿ƒï¼šè‡ªå‹•å°‹æ‰¾å¯ç”¨çš„éº¥å…‹é¢¨
# ==========================================
def find_working_mic():
    print("\nğŸ” æ­£åœ¨è‡ªå‹•æƒæå¯ç”¨çš„éº¥å…‹é¢¨é…ç½®...")
    test_rates = [48000, 44100]
    devices = sd.query_devices()
    for i, device in enumerate(devices):
        if device['max_input_channels'] > 0:
            device_name = device['name']
            if "Stereo Mix" in device_name or "ç«‹é«”è²æ··éŸ³" in device_name:
                continue
            print(f"  æ­£åœ¨æ¸¬è©¦è£ç½® [{i}] {device_name}...", end="")
            for rate in test_rates:
                try:
                    sd.check_input_settings(device=i, channels=1, dtype='int16', samplerate=rate)
                    test_rec = sd.rec(int(0.1 * rate), samplerate=rate, channels=1, device=i, dtype='int16')
                    sd.wait()
                    print(f" âœ… æˆåŠŸ! ({rate}Hz)")
                    return {"device": i, "rate": rate, "name": device_name}
                except Exception:
                    continue
            print(" âŒ å¤±æ•—")
    return None

# ==========================================
# æ‹¼éŸ³æ•¸æ“šåº«
# ==========================================
class PinyinDatabase:
    def __init__(self):
        self.vocabulary = {
            'a': {'1': 'é˜¿', '2': 'å•Š', '3': 'é˜¿', '4': 'å•Š'},
            'ai': {'1': 'åŸƒ', '2': 'ç™Œ', '3': 'çŸ®', '4': 'æ„›'},
            'an': {'1': 'å®‰', '3': 'ä¿º', '4': 'æŒ‰'},
            'ang': {'2': 'æ˜‚', '4': 'ç›'},
            'ao': {'1': 'å‡¹', '2': 'ç†¬', '3': 'è¥–', '4': 'å¥§'},
            'ba': {'1': 'å…«', '2': 'æ‹”', '3': 'æŠŠ', '4': 'çˆ¸'},
            'bai': {'1': 'æ°', '2': 'ç™½', '3': 'æ“º', '4': 'æ‹œ'},
            'ban': {'1': 'ç­', '2': 'èˆ¬', '3': 'ç‰ˆ', '4': 'åŠ'},
            'bang': {'1': 'å¹«', '3': 'ç¶', '4': 'æ£’'},
            'bao': {'1': 'åŒ…', '2': 'é›¹', '3': 'å¯¶', '4': 'å ±'},
            'bei': {'1': 'æ¯', '3': 'åŒ—', '4': 'è¢«'},
            'ben': {'1': 'å¥”', '3': 'æœ¬', '4': 'ç¬¨'},
            'beng': {'1': 'å´©', '3': 'ç¹ƒ', '4': 'è¹¦'},
            'bi': {'1': 'é€¼', '2': 'é¼»', '3': 'ç­†', '4': 'å¿…'},
            'bian': {'1': 'é‚Š', '3': 'è´¬', '4': 'è®Š'},
            'biao': {'1': 'æ¨™', '3': 'è¡¨', '4': 'é³”'},
            'bie': {'1': 'æ†‹', '2': 'åˆ¥', '3': 'æ’‡', '4': 'åˆ¥'},
            'bin': {'1': 'è³“', '4': 'é¬¢'},
            'bing': {'1': 'å†°', '3': 'é¤…', '4': 'ç—…'},
            'bo': {'1': 'æ³¢', '2': 'ä¼¯', '3': 'è·›', '4': 'æ’­'},
            'bu': {'3': 'è£œ', '4': 'ä¸'},
            'ca': {'1': 'æ“¦'},
            'cai': {'1': 'çŒœ', '2': 'æ‰', '3': 'æ¡', '4': 'èœ'},
            'can': {'1': 'é¤', '2': 'æ®˜', '3': 'æ…˜', '4': 'ç‡¦'},
            'cang': {'1': 'å€‰', '2': 'è—'},
            'cao': {'1': 'æ“', '2': 'æ›¹', '3': 'è‰', '4': 'ç³™'},
            'ce': {'4': 'å†Š'},
            'cen': {'1': 'åƒ'},
            'ceng': {'2': 'å±¤', '4': 'è¹­'},
            'cha': {'1': 'æ’', '2': 'èŒ¶', '3': 'æŸ¥', '4': 'å·®'},
            'chai': {'1': 'æ‹†', '2': 'æŸ´'},
            'chan': {'1': 'æ‘»', '2': 'çº', '3': 'ç”¢', '4': 'é¡«'},
            'chang': {'1': 'æ˜Œ', '2': 'é•·', '3': 'å ´', '4': 'å”±'},
            'chao': {'1': 'è¶…', '2': 'æœ', '3': 'åµ', '4': 'ç‚’'},
            'che': {'1': 'è»Š', '3': 'æ‰¯', '4': 'æ’¤'},
            'chen': {'1': 'ç›', '2': 'å¡µ', '3': 'æ²ˆ', '4': 'è¶'},
            'cheng': {'1': 'ç¨±', '2': 'æˆ', '3': 'é€', '4': 'ç¨±'},
            'chi': {'1': 'åƒ', '2': 'æŒ', '3': 'å°º', '4': 'ç¿…'},
            'chong': {'1': 'å……', '2': 'èŸ²', '3': 'å¯µ', '4': 'è¡'},
            'chou': {'1': 'æŠ½', '2': 'æ„', '3': 'é†œ', '4': 'è‡­'},
            'chu': {'1': 'å‡º', '2': 'é™¤', '3': 'è™•', '4': 'è§¸'},
            'chuan': {'1': 'ç©¿', '2': 'èˆ¹', '3': 'å–˜', '4': 'ä¸²'},
            'chuang': {'1': 'çª—', '2': 'åºŠ', '3': 'é—–', '4': 'å‰µ'},
            'chui': {'1': 'å¹', '2': 'å‚'},
            'chun': {'1': 'æ˜¥', '2': 'ç´”', '3': 'è ¢'},
            'chuo': {'1': 'æˆ³', '4': 'ç¶½'},
            'ci': {'1': 'ç–µ', '2': 'è©', '3': 'æ­¤', '4': 'æ¬¡'},
            'cong': {'1': 'è”¥', '2': 'å¾'},
            'cou': {'4': 'æ¹Š'},
            'cu': {'1': 'ç²—', '4': 'é†‹'},
            'cuan': {'1': 'èº¥', '4': 'ç«„'},
            'cui': {'1': 'å‚¬', '3': 'ç’€', '4': 'è„†'},
            'cun': {'1': 'æ‘', '2': 'å­˜', '3': 'å¯¸'},
            'cuo': {'1': 'æ“', '2': 'éŠ¼', '4': 'éŒ¯'},
            'da': {'1': 'æ­', '2': 'ç­”', '3': 'æ‰“', '4': 'å¤§'},
            'dai': {'1': 'å‘†', '3': 'æ­¹', '4': 'å¸¶'},
            'dan': {'1': 'å–®', '3': 'è†½', '4': 'è›‹'},
            'dang': {'1': 'ç•¶', '3': 'æ“‹', '4': 'ç›ª'},
            'dao': {'1': 'åˆ€', '3': 'å°', '4': 'åˆ°'},
            'de': {'1': 'å¾—', '2': 'å¾·'},
            'deng': {'1': 'ç‡ˆ', '3': 'ç­‰', '4': 'é„§'},
            'di': {'1': 'ä½', '2': 'æ•µ', '3': 'åº•', '4': 'åœ°'},
            'dian': {'1': 'é¡›', '3': 'é»', '4': 'é›»'},
            'diao': {'1': 'åˆ', '3': 'é³¥', '4': 'æ‰'},
            'die': {'1': 'è·Œ', '2': 'ç–Š', '3': 'ğ¬º¼', '4': 'ç¢Ÿ'},
            'ding': {'1': 'ä¸', '3': 'é ‚', '4': 'å®š'},
            'diu': {'1': 'ä¸Ÿ'},
            'dong': {'1': 'æ±', '3': 'æ‡‚', '4': 'å‹•'},
            'dou': {'1': 'å…œ', '3': 'æŠ–', '4': 'è±†'},
            'du': {'1': 'éƒ½', '2': 'è®€', '3': 'è³­', '4': 'åº¦'},
            'duan': {'1': 'ç«¯', '3': 'çŸ­', '4': 'æ–·'},
            'dui': {'1': 'å †', '3': 'é §', '4': 'å°'},
            'dun': {'1': 'è¹²', '3': 'ç›¾', '4': 'é “'},
            'duo': {'1': 'å¤š', '2': 'å¥ª', '3': 'æœµ', '4': 'å¢®'},
            'e': {'1': 'é˜¿', '2': 'éµ', '3': 'å™', '4': 'é¤“'},
            'en': {'1': 'æ©'},
            'er': {'2': 'å…’', '3': 'çˆ¾', '4': 'äºŒ'},
            'fa': {'1': 'ç™¼', '2': 'ç½°', '3': 'æ³•', '4': 'é«®'},
            'fan': {'1': 'ç¿»', '2': 'å‡¡', '3': 'å', '4': 'é£¯'},
            'fang': {'1': 'æ–¹', '2': 'æˆ¿', '3': 'è¨ª', '4': 'æ”¾'},
            'fei': {'1': 'é£›', '2': 'è‚¥', '3': 'åŒª', '4': 'è²»'},
            'fen': {'1': 'åˆ†', '2': 'å¢³', '3': 'ç²‰', '4': 'ä»½'},
            'feng': {'1': 'é¢¨', '2': 'é€¢', '3': 'è«·', '4': 'é³³'},
            'fo': {'2': 'ä½›'},
            'fou': {'3': 'å¦'},
            'fu': {'1': 'å¤«', '2': 'ç¦', '3': 'åºœ', '4': 'å¾©'},
            'ga': {'1': 'å’–', '2': 'å˜', '3': 'å°¬', '4': 'å°¬'},
            'gai': {'1': 'è©²', '3': 'æ”¹', '4': 'è“‹'},
            'gan': {'1': 'ä¹¾', '3': 'æ„Ÿ', '4': 'å¹¹'},
            'gang': {'1': 'å‰›', '3': 'å´—', '4': 'é‹¼'},
            'gao': {'1': 'é«˜', '3': 'æ', '4': 'å‘Š'},
            'ge': {'1': 'å“¥', '2': 'æ ¼', '3': 'è‘›', '4': 'å€‹'},
            'gei': {'3': 'çµ¦'},
            'gen': {'1': 'æ ¹', '3': 'äº™', '4': 'äº™'},
            'geng': {'1': 'æ›´', '3': 'æ¢—', '4': 'æ›´'},
            'gong': {'1': 'å·¥', '3': 'æ‹±', '4': 'å…±'},
            'gou': {'1': 'æº', '3': 'ç‹—', '4': 'å¤ '},
            'gu': {'1': 'å§‘', '2': 'å¤', '3': 'è°·', '4': 'æ•…'},
            'gua': {'1': 'ç“œ', '3': 'å¯¡', '4': 'æ›'},
            'guai': {'1': 'ä¹–', '3': 'æ‹', '4': 'æ€ª'},
            'guan': {'1': 'é—œ', '3': 'ç®¡', '4': 'æ…£'},
            'guang': {'1': 'å…‰', '3': 'å»£', '4': 'é€›'},
            'gui': {'1': 'æ­¸', '3': 'é¬¼', '4': 'è²´'},
            'gun': {'1': 'æ»¾', '3': 'æ»¾', '4': 'æ£'},
            'guo': {'1': 'éƒ­', '2': 'åœ‹', '3': 'æœ', '4': 'é'},
            'ha': {'1': 'å“ˆ', '2': 'è›¤', '3': 'å“ˆ', '4': 'å“ˆ'},
            'hai': {'1': 'å—¨', '2': 'å­©', '3': 'æµ·', '4': 'å®³'},
            'han': {'1': 'æ†¨', '2': 'å¯’', '3': 'å–Š', '4': 'æ¼¢'},
            'hang': {'1': 'å¤¯', '2': 'è¡Œ', '4': 'å··'},
            'hao': {'1': 'å¥½', '2': 'æ¯«', '3': 'å¥½', '4': 'è™Ÿ'},
            'he': {'1': 'å–', '2': 'å’Œ', '3': 'å¯', '4': 'è³€'},
            'hei': {'1': 'é»‘'},
            'hen': {'3': 'å¾ˆ', '4': 'æ¨'},
            'heng': {'1': 'äº¨', '2': 'æ©«'},
            'hong': {'1': 'è½Ÿ', '2': 'ç´…', '3': 'å“„', '4': 'é¬¨'},
            'hou': {'1': 'å¼', '2': 'çŒ´', '3': 'å¼', '4': 'å¾Œ'},
            'hu': {'1': 'å‘¼', '2': 'æ¹–', '3': 'è™', '4': 'æˆ¶'},
            'hua': {'1': 'èŠ±', '2': 'è¯', '4': 'è©±'},
            'huai': {'2': 'æ‡·', '4': 'å£'},
            'huan': {'1': 'æ­¡', '2': 'é‚„', '3': 'ç·©', '4': 'æ›'},
            'huang': {'1': 'è’', '2': 'é»ƒ', '3': 'è¬Š', '4': 'æ™ƒ'},
            'hui': {'1': 'ç°', '2': 'å›', '3': 'æ‚”', '4': 'æœƒ'},
            'hun': {'1': 'å©š', '2': 'é­‚', '3': 'æ··', '4': 'æ··'},
            'huo': {'1': 'è±', '2': 'æ´»', '3': 'ç«', '4': 'æˆ–'},
            'ji': {'1': 'é›', '2': 'æ¥µ', '3': 'å¹¾', '4': 'è¨˜'},
            'jia': {'1': 'å®¶', '2': 'å¤¾', '3': 'å‡', '4': 'åƒ¹'},
            'jian': {'1': 'é–“', '3': 'å‰ª', '4': 'è¦‹'},
            'jiang': {'1': 'æ±Ÿ', '3': 'è¬›', '4': 'å°‡'},
            'jiao': {'1': 'äº¤', '2': 'åš¼', '3': 'è§’', '4': 'å«'},
            'jie': {'1': 'æ¥', '2': 'çµ', '3': 'è§£', '4': 'ç•Œ'},
            'jin': {'1': 'é‡‘', '3': 'éŒ¦', '4': 'é€²'},
            'jing': {'1': 'äº¬', '3': 'æ™¯', '4': 'éœ'},
            'jiong': {'1': 'æ‰ƒ', '3': 'çª˜'},
            'jiu': {'1': 'ç©¶', '3': 'ä¹', '4': 'èˆŠ'},
            'ju': {'1': 'å±…', '2': 'å±€', '3': 'èˆ‰', '4': 'å¥'},
            'juan': {'1': 'æ', '3': 'æ²', '4': 'å·'},
            'jue': {'1': 'æ’…', '2': 'è¦º', '3': 'è¹¶', '4': 'æ±º'},
            'jun': {'1': 'è»', '4': 'ä¿Š'},
            'ka': {'1': 'å’–', '3': 'å¡'},
            'kai': {'1': 'é–‹', '3': 'å‡±', '4': 'æ„¾'},
            'kan': {'1': 'çœ‹', '3': 'ç ', '4': 'çœ‹'},
            'kang': {'1': 'åº·', '2': 'æ‰›', '4': 'æŠ—'},
            'kao': {'1': 'è€ƒ', '3': 'è€ƒ', '4': 'é '},
            'ke': {'1': 'ç§‘', '2': 'å’³', '3': 'å¯', '4': 'å®¢'},
            'ken': {'3': 'è‚¯', '4': 'å•ƒ'},
            'keng': {'1': 'å‘'},
            'kong': {'1': 'ç©º', '3': 'æ', '4': 'ç©º'},
            'kou': {'1': 'æ‘³', '3': 'å£', '4': 'æ‰£'},
            'ku': {'1': 'å“­', '3': 'è‹¦', '4': 'åº«'},
            'kua': {'1': 'èª‡', '3': 'å®', '4': 'è·¨'},
            'kuai': {'3': 'æ‹', '4': 'å¿«'},
            'kuan': {'1': 'å¯¬', '3': 'æ¬¾'},
            'kuang': {'1': 'åŒ¡', '2': 'ç‹‚', '3': 'ç¤¦', '4': 'æ³'},
            'kui': {'1': 'è™§', '2': 'è‘µ', '3': 'å‚€', '4': 'æ½°'},
            'kun': {'1': 'å¤', '3': 'æ†', '4': 'å›°'},
            'kuo': {'4': 'æ‹¬'},
            'la': {'1': 'æ‹‰', '2': 'æ‹‰', '3': 'å–‡', '4': 'è¾£'},
            'lai': {'2': 'ä¾†', '4': 'è³´'},
            'lan': {'2': 'è˜­', '3': 'æ‡¶', '4': 'çˆ›'},
            'lang': {'1': 'éƒ', '2': 'ç‹¼', '3': 'æœ—', '4': 'æµª'},
            'lao': {'1': 'æ’ˆ', '2': 'å‹', '3': 'è€', '4': 'é…ª'},
            'le': {'4': 'æ¨‚'},
            'lei': {'1': 'å‹’', '2': 'é›·', '3': 'ç´¯', '4': 'é¡'},
            'leng': {'2': 'ç¨œ', '3': 'å†·', '4': 'æ„£'},
            'li': {'1': 'å“©', '2': 'é›¢', '3': 'è£¡', '4': 'åŠ›'},
            'lia': {'3': 'å€†'},
            'lian': {'1': 'è¯', '2': 'é€£', '3': 'è‡‰', '4': 'ç·´'},
            'liang': {'2': 'è‰¯', '3': 'å…©', '4': 'äº®'},
            'liao': {'1': 'æ’©', '2': 'èŠ', '3': 'äº†', '4': 'æ–™'},
            'lie': {'1': 'å’§', '3': 'å’§', '4': 'åˆ—'},
            'lin': {'1': 'æ—', '2': 'è‡¨', '3': 'å‡œ', '4': 'å'},
            'ling': {'1': 'æ‹', '2': 'éˆ', '3': 'é ˜', '4': 'ä»¤'},
            'liu': {'1': 'æºœ', '2': 'æµ', '3': 'æŸ³', '4': 'å…­'},
            'long': {'1': 'éš†', '2': 'é¾', '3': 'æ”', '4': 'å¼„'},
            'lou': {'1': 'æ‘Ÿ', '2': 'æ¨“', '3': 'æ‘Ÿ', '4': 'æ¼'},
            'lu': {'1': 'åš•', '2': 'ç›§', '3': 'é­¯', '4': 'è·¯'},
            'lv': {'2': 'é©¢', '3': 'æ—…', '4': 'ç¶ '},
            'luan': {'2': 'å·’', '3': 'åµ', '4': 'äº‚'},
            'lue': {'3': 'æ ', '4': 'ç•¥'},
            'lun': {'1': 'æ„', '2': 'å€«', '4': 'è«–'},
            'luo': {'1': 'ç¾…', '2': 'ç¾…', '3': 'è£¸', '4': 'è½'},
            'ma': {'1': 'åª½', '2': 'éº»', '3': 'é¦¬', '4': 'ç½µ'},
            'mai': {'2': 'åŸ‹', '3': 'è²·', '4': 'è³£'},
            'man': {'1': 'æ›¼', '2': 'ç', '3': 'æ»¿', '4': 'æ…¢'},
            'mang': {'2': 'å¿™', '3': 'è½'},
            'mao': {'1': 'è²“', '2': 'æ¯›', '3': 'å¯', '4': 'å¸½'},
            'me': {'0': 'éº¼'},
            'mei': {'2': 'æ²’', '3': 'ç¾', '4': 'å¦¹'},
            'men': {'1': 'æ‚¶', '2': 'é–€'},
            'meng': {'1': 'è’™', '2': 'ç›Ÿ', '3': 'çŒ›', '4': 'å¤¢'},
            'mi': {'1': 'å’ª', '2': 'è¿·', '3': 'ç±³', '4': 'å¯†'},
            'mian': {'1': 'æ£‰', '2': 'æ£‰', '3': 'å…', '4': 'éºµ'},
            'miao': {'1': 'å–µ', '2': 'è‹—', '3': 'ç§’', '4': 'å»Ÿ'},
            'mie': {'1': 'å’©', '4': 'æ»…'},
            'min': {'2': 'æ°‘', '3': 'æ•'},
            'ming': {'2': 'æ˜', '3': 'éŠ˜', '4': 'å‘½'},
            'miu': {'4': 'è¬¬'},
            'mo': {'1': 'æ‘¸', '2': 'æ¨¡', '3': 'æŠ¹', '4': 'æœ«'},
            'mou': {'2': 'è¬€', '3': 'æŸ'},
            'mu': {'2': 'æ¨¡', '3': 'ç‰¡', '4': 'æœ¨'},
            'na': {'1': 'é‚£', '2': 'æ‹¿', '3': 'å“ª', '4': 'é‚£'},
            'nai': {'3': 'å¥¶', '4': 'è€'},
            'nan': {'1': 'å—', '2': 'å—', '3': 'èµ§', '4': 'é›£'},
            'nang': {'1': 'å›Š', '2': 'å›Š', '3': 'æ”®'},
            'nao': {'1': 'æ’“', '2': 'æ’“', '3': 'è…¦', '4': 'é¬§'},
            'ne': {'0': 'å‘¢'},
            'nei': {'3': 'é¤’', '4': 'å…§'},
            'nen': {'4': 'å«©'},
            'neng': {'2': 'èƒ½'},
            'ni': {'1': 'å¦®', '2': 'æ³¥', '3': 'ä½ ', '4': 'é€†'},
            'nian': {'1': 'è”«', '2': 'å¹´', '3': 'æ”†', '4': 'å¿µ'},
            'niang': {'2': 'å¨˜', '4': 'é‡€'},
            'niao': {'3': 'é³¥', '4': 'å°¿'},
            'nie': {'1': 'æ', '4': 'å­½'},
            'nin': {'2': 'æ‚¨'},
            'ning': {'2': 'å¯§', '3': 'æ“°', '4': 'å¯§'},
            'niu': {'1': 'å¦', '2': 'ç‰›', '3': 'æ‰­', '4': 'ç´'},
            'nong': {'2': 'è¾²', '4': 'å¼„'},
            'nou': {'4': 'è€¨'},
            'nu': {'2': 'å¥´', '3': 'åŠª', '4': 'æ€’'},
            'nv': {'3': 'å¥³', '4': 'æœ’'},
            'nuan': {'3': 'æš–'},
            'nue': {'4': 'è™'},
            'nuo': {'2': 'æŒª', '4': 'è«¾'},
            'ou': {'1': 'æ­', '3': 'å¶', '4': 'æ²¤'},
            'pa': {'1': 'è¶´', '2': 'çˆ¬', '4': 'æ€•'},
            'pai': {'1': 'æ‹', '2': 'æ’', '4': 'æ´¾'},
            'pan': {'1': 'æ”€', '2': 'ç›¤', '4': 'åˆ¤'},
            'pang': {'1': 'ä¹“', '2': 'æ—', '4': 'èƒ–'},
            'pao': {'1': 'æ‹‹', '2': 'è¢', '3': 'è·‘', '4': 'æ³¡'},
            'pei': {'1': 'èƒš', '2': 'åŸ¹', '4': 'é…'},
            'pen': {'1': 'å™´', '2': 'ç›†'},
            'peng': {'1': 'ç °', '2': 'æœ‹', '3': 'æ§', '4': 'ç¢°'},
            'pi': {'1': 'æ‰¹', '2': 'çš®', '3': 'åŒ¹', '4': 'å±'},
            'pian': {'1': 'ç¯‡', '2': 'ä¾¿', '4': 'ç‰‡'},
            'piao': {'1': 'é£„', '2': 'ç“¢', '3': 'æ¼‚', '4': 'ç¥¨'},
            'pie': {'1': 'æ’‡', '3': 'æ’‡'},
            'pin': {'1': 'æ‹¼', '2': 'è²§', '3': 'å“', '4': 'è˜'},
            'ping': {'1': 'ä¹’', '2': 'å¹³', '4': 'å¨‰'},
            'po': {'1': 'å¡', '2': 'å©†', '3': 'åµ', '4': 'ç ´'},
            'pou': {'1': 'å‰–'},
            'pu': {'1': 'æ’²', '2': 'è‘¡', '3': 'æ™®', '4': 'ç€‘'},
            'qi': {'1': 'ä¸ƒ', '2': 'é½Š', '3': 'èµ·', '4': 'æ°£'},
            'qia': {'1': 'æ', '3': 'å¡', '4': 'æ´½'},
            'qian': {'1': 'åƒ', '2': 'éŒ¢', '3': 'æ·º', '4': 'æ¬ '},
            'qiang': {'1': 'æ§', '2': 'å¼·', '3': 'æ¶', '4': 'å—†'},
            'qiao': {'1': 'æ•²', '2': 'æ©‹', '3': 'å·§', '4': 'ä¿'},
            'qie': {'1': 'åˆ‡', '2': 'èŒ„', '3': 'ä¸”', '4': 'åˆ‡'},
            'qin': {'1': 'è¦ª', '2': 'ç´', '3': 'å¯¢', '4': 'æ²'},
            'qing': {'1': 'é’', '2': 'æƒ…', '3': 'è«‹', '4': 'æ…¶'},
            'qiong': {'2': 'çª®'},
            'qiu': {'1': 'ç§‹', '2': 'çƒ', '3': 'ç³—', '4': 'æ³…'},
            'qu': {'1': 'å€', '2': 'æ¸ ', '3': 'æ›²', '4': 'å»'},
            'quan': {'1': 'åœˆ', '2': 'å…¨', '3': 'çŠ¬', '4': 'å‹¸'},
            'que': {'1': 'ç¼º', '2': 'ç˜¸', '4': 'å»'},
            'qun': {'2': 'ç¾¤'},
            'ran': {'2': 'ç„¶', '3': 'æŸ“'},
            'rang': {'1': 'åš·', '2': 'æ”˜', '3': 'å£¤', '4': 'è®“'},
            'rao': {'2': 'é¥’', '3': 'æ“¾', '4': 'ç¹'},
            're': {'4': 'ç†±'},
            'ren': {'2': 'äºº', '3': 'å¿', '4': 'ä»»'},
            'reng': {'1': 'æ‰”', '4': 'ä»'},
            'ri': {'4': 'æ—¥'},
            'rong': {'2': 'æ¦®', '3': 'å†—'},
            'rou': {'2': 'æŸ”', '4': 'è‚‰'},
            'ru': {'2': 'å¦‚', '3': 'ä¹³', '4': 'å…¥'},
            'ruan': {'3': 'è»Ÿ'},
            'rui': {'3': 'è•Š', '4': 'ç‘'},
            'run': {'2': 'æ½¤', '4': 'é–'},
            'ruo': {'4': 'å¼±'},
            'sa': {'1': 'æ’’', '3': 'ç‘', '4': 'è–©'},
            'sai': {'1': 'å¡', '4': 'è³½'},
            'san': {'1': 'ä¸‰', '3': 'å‚˜', '4': 'æ•£'},
            'sang': {'1': 'æ¡‘', '3': 'å—“', '4': 'å–ª'},
            'sao': {'1': 'é¨·', '3': 'æƒ', '4': 'å«‚'},
            'se': {'4': 'è‰²'},
            'sen': {'1': 'æ£®'},
            'seng': {'1': 'åƒ§'},
            'sha': {'1': 'æ®º', '3': 'å‚»', '4': 'ç…'},
            'shai': {'3': 'ç¯©', '4': 'æ›¬'},
            'shan': {'1': 'å±±', '3': 'é–ƒ', '4': 'æ‰‡'},
            'shang': {'1': 'å‚·', '3': 'è³', '4': 'ä¸Š'},
            'shao': {'1': 'ç‡’', '2': 'å‹º', '3': 'å°‘', '4': 'å“¨'},
            'she': {'1': 'å¥¢', '2': 'è›‡', '3': 'æ¨', '4': 'ç¤¾'},
            'shei': {'2': 'èª°'},
            'shen': {'1': 'èº«', '2': 'ç¥', '3': 'å¯©', '4': 'è…'},
            'sheng': {'1': 'è²', '2': 'ç¹©', '3': 'çœ', '4': 'è–'},
            'shi': {'1': 'è©©', '2': 'å', '3': 'å²', '4': 'æ˜¯'},
            'shou': {'1': 'æ”¶', '2': 'ç†Ÿ', '3': 'æ‰‹', '4': 'å—'},
            'shu': {'1': 'æ›¸', '2': 'ç†Ÿ', '3': 'é¼ ', '4': 'æ¨¹'},
            'shua': {'1': 'åˆ·', '3': 'è€'},
            'shuai': {'1': 'æ‘”', '3': 'ç”©', '4': 'å¸¥'},
            'shuan': {'1': 'æ “', '4': 'é–‚'},
            'shuang': {'1': 'é›™', '3': 'çˆ½'},
            'shui': {'2': 'æ°´', '3': 'æ°´', '4': 'ç¡'},
            'shun': {'4': 'é †'},
            'shuo': {'1': 'èªª', '4': 'çˆ'},
            'si': {'1': 'ç§', '3': 'æ­»', '4': 'å››'},
            'song': {'1': 'é¬†', '3': 'è³', '4': 'é€'},
            'sou': {'1': 'æœ', '3': 'è—ª', '4': 'å—½'},
            'su': {'1': 'é…¥', '2': 'ä¿—', '4': 'ç´ '},
            'suan': {'1': 'é…¸', '4': 'ç®—'},
            'sui': {'1': 'é›–', '2': 'éš¨', '3': 'é«“', '4': 'æ­²'},
            'sun': {'1': 'å­«', '3': 'æ', '4': 'æ½ '},
            'suo': {'1': 'ç¸®', '3': 'é–', '4': 'æ‰€'},
            'ta': {'1': 'ä»–', '3': 'å¡”', '4': 'è¸'},
            'tai': {'1': 'èƒ', '2': 'è‡º', '4': 'å¤ª'},
            'tan': {'1': 'è²ª', '2': 'è«‡', '3': 'å¦', '4': 'æ¢'},
            'tang': {'1': 'æ¹¯', '2': 'å”', '3': 'èºº', '4': 'ç‡™'},
            'tao': {'1': 'æ', '2': 'é€ƒ', '3': 'è¨', '4': 'å¥—'},
            'te': {'4': 'ç‰¹'},
            'teng': {'2': 'ç–¼'},
            'ti': {'1': 'æ¢¯', '2': 'æ', '3': 'é«”', '4': 'æ›¿'},
            'tian': {'1': 'å¤©', '2': 'ç”°', '3': 'èˆ”', '4': 'å¡«'},
            'tiao': {'1': 'æŒ‘', '2': 'æ¢', '3': 'æŒ‘', '4': 'è·³'},
            'tie': {'1': 'è²¼', '3': 'éµ', '4': 'å¸–'},
            'ting': {'1': 'è½', '2': 'åœ', '3': 'æŒº', '4': 'å»³'},
            'tong': {'1': 'é€š', '2': 'åŒ', '3': 'çµ±', '4': 'ç—›'},
            'tou': {'1': 'å·', '2': 'é ­', '3': 'ä±', '4': 'é€'},
            'tu': {'1': 'ç¦¿', '2': 'åœ–', '3': 'åœŸ', '4': 'å…”'},
            'tuan': {'1': 'æ¹', '2': 'åœ˜', '3': 'ç–ƒ', '4': 'å½–'},
            'tui': {'1': 'æ¨', '2': 'é ¹', '3': 'è…¿', '4': 'é€€'},
            'tun': {'1': 'å', '2': 'å›¤', '3': 'æ±†', '4': 'è¤ª'},
            'tuo': {'1': 'è„«', '2': 'é™€', '3': 'å¦¥', '4': 'æ‹“'},
            'wa': {'1': 'æŒ–', '2': 'å¨ƒ', '3': 'ç“¦', '4': 'è¥ª'},
            'wai': {'1': 'æ­ª', '3': 'å´´', '4': 'å¤–'},
            'wan': {'1': 'ç£', '2': 'å®Œ', '3': 'æ™š', '4': 'è¬'},
            'wang': {'1': 'æ±ª', '2': 'ç‹', '3': 'ç¶²', '4': 'å¿˜'},
            'wei': {'1': 'å¨', '2': 'åœ', '3': 'å‰', '4': 'ä½'},
            'wen': {'1': 'æº«', '2': 'æ–‡', '3': 'å»', '4': 'å•'},
            'weng': {'1': 'ç¿', '3': 'è“Š', '4': 'ç”•'},
            'wo': {'1': 'çª©', '3': 'æˆ‘', '4': 'æ¡'},
            'wu': {'1': 'å±‹', '2': 'ç„¡', '3': 'äº”', '4': 'ç‰©'},
            'xi': {'1': 'è¥¿', '2': 'ç¿’', '3': 'æ´—', '4': 'ç´°'},
            'xia': {'1': 'ç', '2': 'ä¿ ', '3': 'å¤', '4': 'ä¸‹'},
            'xian': {'1': 'å…ˆ', '2': 'å’¸', '3': 'éšª', '4': 'ç·š'},
            'xiang': {'1': 'é¦™', '2': 'è©³', '3': 'æƒ³', '4': 'åƒ'},
            'xiao': {'1': 'æ¶ˆ', '2': 'æ·†', '3': 'å°', '4': 'ç¬‘'},
            'xie': {'1': 'äº›', '2': 'é‹', '3': 'å¯«', '4': 'è¬'},
            'xin': {'1': 'æ–°', '2': 'å°‹', '3': 'å¿ƒ', '4': 'ä¿¡'},
            'xing': {'1': 'æ˜Ÿ', '2': 'è¡Œ', '3': 'é†’', '4': 'æ€§'},
            'xiong': {'1': 'å…„', '2': 'ç†Š', '3': 'é›„', '4': 'å…‡'},
            'xiu': {'1': 'ä¿®', '3': 'æœ½', '4': 'ç§€'},
            'xu': {'1': 'éœ€', '2': 'å¾', '3': 'è¨±', '4': 'åº'},
            'xuan': {'1': 'å®£', '2': 'æ‡¸', '3': 'é¸', '4': 'ç‚«'},
            'xue': {'1': 'é´', '2': 'å­¸', '3': 'é›ª', '4': 'ç©´'},
            'xun': {'1': 'å‹³', '2': 'å°‹', '3': 'è¨“', '4': 'è¨Š'},
            'ya': {'1': 'é´¨', '2': 'ç‰™', '3': 'é›…', '4': 'äº'},
            'yan': {'1': 'ç…™', '2': 'åš´', '3': 'çœ¼', '4': 'é©—'},
            'yang': {'1': 'å¤®', '2': 'ç¾Š', '3': 'é¤Š', '4': 'æ¨£'},
            'yao': {'1': 'è…°', '2': 'æ–', '3': 'å’¬', '4': 'è¦'},
            'ye': {'1': 'è€¶', '2': 'çˆº', '3': 'ä¹Ÿ', '4': 'å¤œ'},
            'yi': {'1': 'ä¸€', '2': 'å§¨', '3': 'ä»¥', '4': 'æ„'},
            'yin': {'1': 'å› ', '2': 'éŠ€', '3': 'å¼•', '4': 'å°'},
            'ying': {'1': 'è‹±', '2': 'ç‡Ÿ', '3': 'å½±', '4': 'ç¡¬'},
            'yo': {'1': 'å–²'},
            'yong': {'1': 'æ“', '3': 'æ°¸', '4': 'ç”¨'},
            'you': {'1': 'å„ª', '2': 'æ¸¸', '3': 'æœ‰', '4': 'å³'},
            'yu': {'1': 'é­š', '2': 'ä¸', '3': 'èª', '4': 'é‡'},
            'yuan': {'1': 'å†¤', '2': 'åœ“', '3': 'é ', '4': 'é¡˜'},
            'yue': {'1': 'ç´„', '4': 'æœˆ'},
            'yun': {'1': 'æšˆ', '2': 'é›²', '3': 'å…', '4': 'é‹'},
            'za': {'1': 'æ‰', '2': 'é›œ', '3': 'å’‹', '4': 'ç ¸'},
            'zai': {'1': 'æ ½', '3': 'å®°', '4': 'åœ¨'},
            'zan': {'1': 'ç°ª', '2': 'å’±', '3': 'æ”¢', '4': 'è´Š'},
            'zang': {'1': 'é«’', '4': 'è‘¬'},
            'zao': {'1': 'é­', '2': 'é‘¿', '3': 'æ—©', '4': 'é€ '},
            'ze': {'2': 'è²¬', '4': 'ä»„'},
            'zei': {'2': 'è³Š'},
            'zen': {'3': 'æ€'},
            'zeng': {'1': 'æ›¾', '4': 'è´ˆ'},
            'zha': {'1': 'æ‰', '2': 'ç‚¸', '3': 'çœ¨', '4': 'ç‚¸'},
            'zhai': {'1': 'æ‘˜', '2': 'å®…', '3': 'çª„', '4': 'å‚µ'},
            'zhan': {'1': 'æ²¾', '3': 'å±•', '4': 'ç«™'},
            'zhang': {'1': 'å¼µ', '3': 'æŒ', '4': 'è³¬'},
            'zhao': {'1': 'æ‹›', '2': 'è‘—', '3': 'æ‰¾', '4': 'ç…§'},
            'zhe': {'1': 'é®', '2': 'å“²', '3': 'è€…', '4': 'é€™'},
            'zhen': {'1': 'çœŸ', '3': 'æ•', '4': 'é™£'},
            'zheng': {'1': 'å¾µ', '3': 'æ•´', '4': 'æ­£'},
            'zhi': {'1': 'çŸ¥', '2': 'ç›´', '3': 'ç´™', '4': 'åˆ¶'},
            'zhong': {'1': 'ä¸­', '3': 'è…«', '4': 'é‡'},
            'zhou': {'1': 'é€±', '2': 'è»¸', '3': 'è‚˜', '4': 'å®™'},
            'zhu': {'1': 'è±¬', '2': 'ç«¹', '3': 'ä¸»', '4': 'ä½'},
            'zhua': {'1': 'æŠ“', '3': 'çˆª'},
            'zhuai': {'3': 'è·©', '4': 'æ‹½'},
            'zhuan': {'1': 'å°ˆ', '3': 'è½‰', '4': 'å‚³'},
            'zhuang': {'1': 'è£', '3': 'å£¯', '4': 'æ’'},
            'zhui': {'1': 'è¿½', '4': 'å¢œ'},
            'zhun': {'1': 'è«„', '3': 'æº–'},
            'zhuo': {'1': 'æ¡Œ', '2': 'å“', '4': 'æ‰'},
            'zi': {'1': 'è³‡', '3': 'ç´«', '4': 'å­—'},
            'zong': {'1': 'å®—', '3': 'ç¸½', '4': 'ç¸±'},
            'zou': {'1': 'é„’', '3': 'èµ°', '4': 'å¥'},
            'zu': {'1': 'ç§Ÿ', '2': 'æ—', '3': 'é˜»', '4': 'è¶³'},
            'zuan': {'1': 'é‘½', '4': 'é‘½'},
            'zui': {'3': 'å˜´', '4': 'æœ€'},
            'zun': {'1': 'å°Š', '4': 'ğ©¯„'},
            'zuo': {'1': 'ä½œ', '2': 'æ˜¨', '3': 'å·¦', '4': 'åš'},
        }

    def get_random_entry(self):
        pinyin_base = random.choice(list(self.vocabulary.keys()))
        tones_dict = self.vocabulary[pinyin_base]
        tone = random.choice(list(tones_dict.keys()))
        character = tones_dict[tone]
        return pinyin_base, tone, character

    @staticmethod
    def to_marks(pinyin_base, tone):
        marks = {
            'a': ['a', 'Ä', 'Ã¡', 'Ç', 'Ã '],
            'o': ['o', 'Å', 'Ã³', 'Ç’', 'Ã²'],
            'e': ['e', 'Ä“', 'Ã©', 'Ä›', 'Ã¨'],
            'i': ['i', 'Ä«', 'Ã­', 'Ç', 'Ã¬'],
            'u': ['u', 'Å«', 'Ãº', 'Ç”', 'Ã¹'],
            'v': ['Ã¼', 'Ç–', 'Ç˜', 'Çš', 'Çœ'],
            'Ã¼': ['Ã¼', 'Ç–', 'Ç˜', 'Çš', 'Çœ'],
        }
        t = int(tone) if (tone and tone.isdigit()) else 0
        if t == 0: return pinyin_base 
        p = pinyin_base.lower()
        if 'a' in p: return p.replace('a', marks['a'][t])
        elif 'o' in p: return p.replace('o', marks['o'][t])
        elif 'e' in p: return p.replace('e', marks['e'][t])
        elif 'ui' in p: return p.replace('i', marks['i'][t])
        elif 'iu' in p: return p.replace('u', marks['u'][t])
        elif 'i' in p: return p.replace('i', marks['i'][t])
        elif 'u' in p: return p.replace('u', marks['u'][t])
        elif 'v' in p: return p.replace('v', marks['v'][t])
        return p + tone

# ==========================================
# èªéŸ³æ’­æ”¾èˆ‡éŒ„éŸ³è©•ä¼°
# ==========================================
class TTSPlayer:
    def __init__(self):
        pygame.mixer.init()
        self.temp_dir = tempfile.gettempdir()

    def generate_and_play(self, character, tone):
        voice = "zh-TW-HsiaoChenNeural"
        rate = "-50%" if tone == '3' else "-15%"
        unique_filename = f"demo_{uuid.uuid4().hex}.mp3"
        audio_path = Path(self.temp_dir) / unique_filename
        try:
            async def _generate():
                communicate = edge_tts.Communicate(character, voice, rate=rate)
                await communicate.save(str(audio_path))
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            nest_asyncio.apply()
            loop.run_until_complete(_generate())
            if audio_path.exists():
                pygame.mixer.music.load(str(audio_path))
                pygame.mixer.music.play()
                while pygame.mixer.music.get_busy():
                    pygame.time.Clock().tick(10)
                pygame.mixer.music.unload()
                os.remove(audio_path)
            return True
        except Exception as e:
            print(f"TTS éŒ¯èª¤: {e}"); return False

class EasyRecorder:
    def __init__(self, mic_config):
        self.mic_config = mic_config
        self.fs = mic_config['rate']
        self.device_id = mic_config['device']
        self.recognizer = sr.Recognizer()

    def record_audio(self, duration=4.0):
        print(f"\nğŸ¤ æº–å‚™éŒ„éŸ³... (3ç§’å¾Œé–‹å§‹)")
        time.sleep(1); print("3..."); time.sleep(1); print("2..."); time.sleep(1); print("1...")
        print("ğŸ”´ è«‹å¤§è²æœ—è®€ï¼")
        try:
            myrecording = sd.rec(int(duration * self.fs), samplerate=self.fs, channels=1, dtype='int16', device=self.device_id)
            sd.wait()
            print("â¹ï¸ éŒ„éŸ³çµæŸ")
            output_file = Path(tempfile.gettempdir()) / "user_rec.wav"
            wav.write(output_file, self.fs, myrecording)
            return str(output_file)
        except Exception as e:
            print(f"éŒ„éŸ³å¤±æ•—: {e}"); return None

    def play_recorded_audio(self, audio_file):
        """æ’­æ”¾ä½¿ç”¨è€…å‰›å‰›éŒ„è£½çš„è²éŸ³"""
        if not audio_file or not os.path.exists(audio_file):
            return
        try:
            pygame.mixer.music.load(audio_file)
            pygame.mixer.music.play()
            while pygame.mixer.music.get_busy():
                pygame.time.Clock().tick(10)
            pygame.mixer.music.unload()
        except Exception as e:
            print(f"å›æ”¾éŒ„éŸ³å¤±æ•—: {e}")

    def assess_pronunciation(self, audio_file, target_char, target_pinyin_mark):
        print("â˜ï¸ æ­£åœ¨è¾¨è­˜ç™¼éŸ³...")
        try:
            with sr.AudioFile(audio_file) as source:
                audio_data = self.recognizer.record(source)
            recognized_text = self.recognizer.recognize_google(audio_data, language="zh-TW")
            clean_rec = recognized_text.strip().replace(" ", "")
            rec_pinyin_list = pinyin(clean_rec, style=Style.TONE)
            rec_pinyin = rec_pinyin_list[0][0] if rec_pinyin_list else "ç„¡æ³•è¾¨è­˜"
            is_correct = (clean_rec[0] == target_char if clean_rec else False)
            return {
                "recognized_text": clean_rec,
                "recognized_pinyin": rec_pinyin,
                "is_correct": is_correct,
                "target_char": target_char,
                "target_pinyin": target_pinyin_mark
            }
        except Exception:
            return {"error": "æŠ±æ­‰ï¼Œæˆ‘è½ä¸æ¸…æ¥šï¼Œè«‹å†è©¦ä¸€æ¬¡ (è«‹ç¢ºä¿ç’°å¢ƒå®‰éœ)"}

# ==========================================
# ä¸»ç¨‹å¼
# ==========================================
def main():
    print("="*50)
    print("      æ¼¢èªæ‹¼éŸ³ç™¼éŸ³ç·´ç¿’ (éŒ„éŸ³å›æ”¾ç‰ˆ)")
    print("="*50)

    mic_config = find_working_mic()
    if not mic_config:
        print("\nâŒ æ‰¾ä¸åˆ°éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥ç¡¬é«”è¨­å®šã€‚")
        return

    db = PinyinDatabase()
    tts = TTSPlayer()
    recorder = EasyRecorder(mic_config)

    while True:
        print("\n[åŠŸèƒ½é¸å–®] 1. é–‹å§‹å‡ºé¡Œ  2. é›¢é–‹")
        choice = input("è«‹é¸æ“‡: ").strip()
        if choice == '2': break
        if choice != '1': continue

        pinyin_base, tone, character = db.get_random_entry()
        pinyin_mark = db.to_marks(pinyin_base, tone)

        print("\n" + "â˜…"*20)
        print(f" é¡Œç›®ï¼š ã€ {character} ã€‘")
        print(f" éŸ³æ¨™ï¼š [ {pinyin_mark} ]")
        print("â˜…"*20)

        print("ğŸ”Š æ’­æ”¾ç¤ºç¯„éŸ³...")
        tts.generate_and_play(character, tone)

        input("\nè«‹æŒ‰ [Enter] éµå¾Œé–‹å§‹éŒ„éŸ³...")
        audio_path = recorder.record_audio()
        
        if audio_path:
            result = recorder.assess_pronunciation(audio_path, character, pinyin_mark)
            print("\n" + "â”"*30)
            if "error" in result:
                print(f"âš ï¸ {result['error']}")
            else:
                if result['is_correct']:
                    print(f"âœ… ğŸ‰ æ­£ç¢ºï¼ç™¼éŸ³å¾ˆæ¨™æº–ï¼")
                else:
                    print(f"âŒ å“å‘€ï¼çµæœï¼šç™¼éŸ³æœ‰èª¤")
                
                print(f"------------------------------")
                print(f" ğŸ‘‰ ç›®æ¨™ï¼š{result['target_char']}  [ {result['target_pinyin']} ]")
                print(f" ğŸ‘‰ ä½ èªªï¼š{result['recognized_text']}  [ {result['recognized_pinyin']} ]")
                print(f"------------------------------")
                
                # è‡ªå‹•å›æ”¾ä½¿ç”¨è€…çš„è²éŸ³
                print("ğŸ§ æ­£åœ¨å›æ”¾ä½ çš„éŒ„éŸ³ï¼Œè«‹å°æ¯”å·®ç•°...")
                recorder.play_recorded_audio(audio_path)
                
            print("â”"*30)

    pygame.mixer.quit()
    print("éŠæˆ²çµæŸï¼Œå†è¦‹ï¼")

if __name__ == "__main__":
    main()